# ğŸ—ï¸ ä»£ç¢¼çµæ§‹æ–‡æª”

å­¸ç”Ÿç®¡ç†ç³»çµ±çš„å®Œæ•´ä»£ç¢¼çµæ§‹èªªæ˜ã€‚
curl -X GET "http://localhost:3000/api/grades/by-student-course?student_id=1&course_id=1"-H "Cookie: userId=s%3A1.yQdeJ1s4GsXb%2FbxjrNeDrVoLVUdFleHogFcbmR05ouE; userType=s%3Astaff.SwDlaK0qA4lvZHTqjqokxt38rBJSIQnX4zzXagkj1lg"
---

## ğŸ“‚ é …ç›®ç›®éŒ„çµæ§‹

```
database/
â”œâ”€â”€ src/                          # æºä»£ç¢¼ç›®éŒ„
â”‚   â”œâ”€â”€ controllers/              # æ§åˆ¶å™¨å±¤ - è™•ç†æ¥­å‹™é‚è¼¯
â”‚   â”‚   â”œâ”€â”€ authController.js         # èªè­‰æ§åˆ¶å™¨ï¼ˆç™»å…¥/ç™»å‡ºï¼‰
â”‚   â”‚   â”œâ”€â”€ studentController.js      # å­¸ç”Ÿç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ gradeController.js        # æˆç¸¾ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ disciplinaryController.js # ç´€å¾‹è¨˜éŒ„æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ staffController.js        # å“¡å·¥ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ guardianController.js     # å®¶é•·ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ courseController.js       # èª²ç¨‹ç®¡ç†æ§åˆ¶å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ routes/                   # è·¯ç”±å±¤ - å®šç¾© API ç«¯é»
â”‚   â”‚   â”œâ”€â”€ auth.js                   # èªè­‰è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ student.js                # å­¸ç”Ÿè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ aro.js                    # æˆç¸¾ç®¡ç†è·¯ç”±ï¼ˆAROï¼‰
â”‚   â”‚   â”œâ”€â”€ dro.js                    # ç´€å¾‹è¨˜éŒ„è·¯ç”±ï¼ˆDROï¼‰
â”‚   â”‚   â”œâ”€â”€ staff.js                  # å“¡å·¥è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ guardian.js               # å®¶é•·è·¯ç”±
â”‚   â”‚   â””â”€â”€ course.js                 # èª²ç¨‹è·¯ç”±
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/               # ä¸­é–“ä»¶å±¤ - è™•ç†è«‹æ±‚æ””æˆª
â”‚   â”‚   â””â”€â”€ auth.js                   # èªè­‰ä¸­é–“ä»¶ï¼ˆæ¬Šé™æ§åˆ¶ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                    # å·¥å…·å±¤
â”‚   â”‚   â””â”€â”€ crypto.js                 # åŠ å¯†å·¥å…·ï¼ˆèªªæ˜æ–‡æª”ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ config.js                 # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ db.js                     # æ•¸æ“šåº«é€£æ¥
â”‚   â””â”€â”€ index.js                  # æ‡‰ç”¨å…¥å£
â”‚
â”œâ”€â”€ migrations/                   # æ•¸æ“šåº«é·ç§»è…³æœ¬
â”‚   â”œâ”€â”€ add_password_columns.sql      # æ·»åŠ å¯†ç¢¼åˆ—
â”‚   â””â”€â”€ encrypt_passwords.sql         # åŠ å¯†ç¾æœ‰å¯†ç¢¼
â”‚
â”œâ”€â”€ comp3335.sql                  # æ•¸æ“šåº«è¡¨çµæ§‹
â”œâ”€â”€ testdata.sql                  # æ¸¬è©¦æ•¸æ“š
â”œâ”€â”€ test-api.js                   # API æ¸¬è©¦è…³æœ¬
â”œâ”€â”€ package.json                  # é …ç›®ä¾è³´é…ç½®
â”œâ”€â”€ API.md                        # API æ¥å£æ–‡æª”
â”œâ”€â”€ STRUCTURE.md                  # ä»£ç¢¼çµæ§‹æ–‡æª”ï¼ˆæœ¬æ–‡æª”ï¼‰
â””â”€â”€ README.md                     # é …ç›®èªªæ˜æ–‡æª”
```

---

## ğŸ¯ æ¶æ§‹è¨­è¨ˆ

### ä¸‰å±¤æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ¶ç«¯                            â”‚
â”‚              (Browser / Postman)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP Request
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è·¯ç”±å±¤ (Routes)                     â”‚
â”‚  - å®šç¾© API ç«¯é»                                     â”‚
â”‚  - èª¿ç”¨ä¸­é–“ä»¶                                        â”‚
â”‚  - è·¯ç”±åˆ°å°æ‡‰æ§åˆ¶å™¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ä¸­é–“ä»¶å±¤ (Middleware)                  â”‚
â”‚  - èº«ä»½é©—è­‰ (authenticate)                          â”‚
â”‚  - æ¬Šé™æª¢æŸ¥ (requireStaff/requireRole)              â”‚
â”‚  - Master Key é©—è­‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ§åˆ¶å™¨å±¤ (Controllers)                  â”‚
â”‚  - è™•ç†æ¥­å‹™é‚è¼¯                                      â”‚
â”‚  - æ•¸æ“šé©—è­‰                                          â”‚
â”‚  - èª¿ç”¨æ•¸æ“šåº«æ“ä½œ                                    â”‚
â”‚  - è¿”å›éŸ¿æ‡‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æ•¸æ“šåº«å±¤ (Database)                    â”‚
â”‚  - MySQL æ•¸æ“šåº«                                      â”‚
â”‚  - Knex.js ORM                                      â”‚
â”‚  - AES åŠ å¯†/è§£å¯†                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ æ ¸å¿ƒæ–‡ä»¶è©³è§£

### 1. `src/index.js` - æ‡‰ç”¨å…¥å£

**ä½œç”¨**: æ‡‰ç”¨ç¨‹åºçš„å•Ÿå‹•æ–‡ä»¶

**ä¸»è¦åŠŸèƒ½**:
- åˆå§‹åŒ– Express æ‡‰ç”¨
- é…ç½®ä¸­é–“ä»¶ï¼ˆJSONã€Cookie Parserï¼‰
- è¨»å†Šæ‰€æœ‰è·¯ç”±
- å•Ÿå‹•æœå‹™å™¨

**ä»£ç¢¼çµæ§‹**:
```javascript
import express from "express";
import cookieParser from "cookie-parser";
import config from "./config.js";

// å°å…¥æ‰€æœ‰è·¯ç”±
import authRoutes from "./routes/auth.js";
import studentRoutes from "./routes/student.js";
// ... å…¶ä»–è·¯ç”±

const app = express();

// ä¸­é–“ä»¶é…ç½®
app.use(express.json());
app.use(cookieParser(config.COOKIE_SECRET));  // å•Ÿç”¨ signed cookies

// è·¯ç”±é…ç½®
app.use("/api/auth", authRoutes);
app.use("/api/students", studentRoutes);
// ... å…¶ä»–è·¯ç”±

// å•Ÿå‹•æœå‹™å™¨
app.listen(config.PORT, () => {
  console.log(`Server listening on port ${config.PORT}`);
});
```

---

### 2. `src/config.js` - é…ç½®æ–‡ä»¶

**ä½œç”¨**: å­˜æ”¾æ‰€æœ‰ç³»çµ±é…ç½®

**é…ç½®é …**:
```javascript
export default {
  PORT: 3000,                           // æœå‹™å™¨ç«¯å£
  DB_HOST: "108.61.182.90",            // æ•¸æ“šåº«ä¸»æ©Ÿ
  DB_USER: "root",                      // æ•¸æ“šåº«ç”¨æˆ¶
  DB_PASSWORD: "yourpassword",          // æ•¸æ“šåº«å¯†ç¢¼
  DB_NAME: "polyu",                     // æ•¸æ“šåº«åç¨±
  AES_KEY: "polyusecretkeyforAES",     // AES åŠ å¯†å¯†é‘°
  COOKIE_SECRET: "your-cookie-secret",  // Cookie ç°½åå¯†é‘°
  MASTER_KEY: "polyusecretkeyforTest"   // è¶…ç´šç®¡ç†å“¡å¯†é‘°
};
```

---

### 3. `src/db.js` - æ•¸æ“šåº«é€£æ¥

**ä½œç”¨**: é…ç½®ä¸¦å°å‡º Knex æ•¸æ“šåº«å¯¦ä¾‹

**ä¸»è¦åŠŸèƒ½**:
- ä½¿ç”¨ Knex.js é€£æ¥ MySQL
- é…ç½®é€£æ¥æ± 
- å°å‡ºæ•¸æ“šåº«å¯¦ä¾‹ä¾›å…¶ä»–æ¨¡å¡Šä½¿ç”¨

**ä»£ç¢¼çµæ§‹**:
```javascript
import knex from "knex";
import config from "./config.js";

const db = knex({
  client: "mysql2",
  connection: {
    host: config.DB_HOST,
    user: config.DB_USER,
    password: config.DB_PASSWORD,
    database: config.DB_NAME,
  },
});

export default db;
```

---

### 4. `src/middleware/auth.js` - èªè­‰ä¸­é–“ä»¶

**ä½œç”¨**: è™•ç†èº«ä»½é©—è­‰å’Œæ¬Šé™æ§åˆ¶

**å°å‡ºçš„ä¸­é–“ä»¶**:

#### a) `authenticate` - åŸºç¤èªè­‰
- æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
- é©—è­‰ signed cookie çš„æœ‰æ•ˆæ€§
- æ”¯æŒ Master Key ç¹é

#### b) `requireStaff` - å“¡å·¥æ¬Šé™
- è¦æ±‚ç”¨æˆ¶å¿…é ˆæ˜¯å“¡å·¥èº«ä»½
- ç”¨æ–¼å“¡å·¥å°ˆå±¬åŠŸèƒ½

#### c) `requireSelfOrStaff` - æœ¬äººæˆ–å“¡å·¥
- å­¸ç”Ÿåªèƒ½è¨ªå•è‡ªå·±çš„æ•¸æ“š
- å“¡å·¥å¯ä»¥è¨ªå•æ‰€æœ‰æ•¸æ“š
- ç”¨æ–¼å­¸ç”Ÿæ•¸æ“šæŸ¥è©¢

#### d) `requireRole(role)` - è§’è‰²æ¬Šé™
- è¦æ±‚å“¡å·¥å…·æœ‰ç‰¹å®šè§’è‰²ï¼ˆARO/DROï¼‰
- ç”¨æ–¼æˆç¸¾å’Œç´€å¾‹è¨˜éŒ„ç®¡ç†

**ä»£ç¢¼çµæ§‹**:
```javascript
// æª¢æŸ¥ Master Key
const masterKey = req.headers['x-master-key'];
if (masterKey === config.MASTER_KEY) {
  req.isMaster = true;
  return next();
}

// æª¢æŸ¥ signed cookie
const userId = req.signedCookies.userId;
const userType = req.signedCookies.userType;

if (!userId || !userType) {
  return res.status(401).json({ 
    success: false, 
    message: "æœªç™»å…¥æˆ–cookieå·²è¢«ç¯¡æ”¹" 
  });
}

req.userId = userId;
req.userType = userType;
next();
```

---

### 5. æ§åˆ¶å™¨å±¤ (Controllers)

æ‰€æœ‰æ§åˆ¶å™¨éµå¾ªçµ±ä¸€çš„çµæ§‹æ¨¡å¼ï¼š

#### æ¨™æº–æ§åˆ¶å™¨æ¨¡æ¿
```javascript
// 1. å°å…¥ä¾è³´
import db from "../db.js";
import config from "../config.js";

// 2. æŸ¥è©¢å‡½æ•¸ï¼ˆGETï¼‰
export const getAll = async (req, res) => {
  try {
    // è§£å¯†æ•æ„Ÿæ•¸æ“š
    const results = await db.raw(`
      SELECT id, name,
      CAST(AES_DECRYPT(email, ?) AS CHAR) as email
      FROM table_name
    `, [config.AES_KEY]);
    
    res.status(200).json({ 
      success: true, 
      data: results[0] 
    });
  } catch (error) {
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
};

// 3. æ·»åŠ å‡½æ•¸ï¼ˆPOSTï¼‰
export const add = async (req, res) => {
  try {
    const { name, email } = req.body;
    
    // åŠ å¯†æ•æ„Ÿæ•¸æ“š
    const result = await db.raw(`
      INSERT INTO table_name (name, email)
      VALUES (?, AES_ENCRYPT(?, ?))
    `, [name, email, config.AES_KEY]);
    
    res.status(200).json({ 
      success: true, 
      data: { id: result[0].insertId } 
    });
  } catch (error) {
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
};

// 4. æ›´æ–°å‡½æ•¸ï¼ˆPUT/POSTï¼‰
export const edit = async (req, res) => {
  // é¡ä¼¼æ·»åŠ å‡½æ•¸
};

// 5. åˆªé™¤å‡½æ•¸ï¼ˆDELETEï¼‰
export const remove = async (req, res) => {
  // åˆªé™¤é‚è¼¯
};
```

---

### 6. è·¯ç”±å±¤ (Routes)

æ‰€æœ‰è·¯ç”±éµå¾ª RESTful è¨­è¨ˆï¼š

#### æ¨™æº–è·¯ç”±æ¨¡æ¿
```javascript
import { Router } from "express";
import { getAll, getById, add, edit, remove } from "../controllers/xxxController.js";
import { authenticate, requireStaff } from "../middleware/auth.js";

const router = Router();

// GET    /api/xxx        - ç²å–æ‰€æœ‰
router.get("/", authenticate, requireStaff, getAll);

// GET    /api/xxx/:id    - ç²å–å–®å€‹
router.get("/:id", authenticate, requireStaff, getById);

// POST   /api/xxx        - æ·»åŠ 
router.post("/", authenticate, requireStaff, add);

// PUT    /api/xxx/:id    - æ›´æ–°
router.put("/:id", authenticate, requireStaff, edit);

// DELETE /api/xxx/:id    - åˆªé™¤
router.delete("/:id", authenticate, requireStaff, remove);

export default router;
```

---

## ğŸ” å®‰å…¨è¨­è¨ˆ

### 1. æ•¸æ“šåŠ å¯†
ä½¿ç”¨ MySQL åŸç”Ÿ AES åŠ å¯†å‡½æ•¸ï¼š

```sql
-- åŠ å¯†
AES_ENCRYPT('plaintext', 'key')

-- è§£å¯†
CAST(AES_DECRYPT(encrypted_data, 'key') AS CHAR)
```

**åŠ å¯†å­—æ®µ**:
- å¯†ç¢¼ (password)
- éƒµç®± (email)
- é›»è©± (phone)
- èº«ä»½è­‰è™Ÿ (identification_number)
- åœ°å€ (address)
- æˆç¸¾ (grade)
- è©•èª (comments)
- ç´€å¾‹æè¿° (descriptions)

---

### 2. Cookie å®‰å…¨
ä½¿ç”¨ Signed Cookie é˜²æ­¢ç¯¡æ”¹ï¼š

```javascript
res.cookie("userId", userId, {
  httpOnly: true,              // é˜²æ­¢ XSS æ”»æ“Š
  signed: true,                // ç°½åé˜²æ­¢ç¯¡æ”¹
  maxAge: 24 * 60 * 60 * 1000, // 24å°æ™‚éæœŸ
  sameSite: 'strict',          // é˜²æ­¢ CSRF æ”»æ“Š
  secure: process.env.NODE_ENV === 'production'  // HTTPS only
});
```

---

### 3. æ¬Šé™æ§åˆ¶

#### ä¸‰ç´šæ¬Šé™é«”ç³»
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Master Key (è¶…ç´šç®¡ç†å“¡)        â”‚
â”‚         ç¹éæ‰€æœ‰æ¬Šé™æª¢æŸ¥               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Staff (å“¡å·¥)   â”‚   â”‚  Student (å­¸ç”Ÿ)   â”‚
â”‚                 â”‚   â”‚                  â”‚
â”‚  - æ™®é€šå“¡å·¥      â”‚   â”‚  - åªèƒ½è¨ªå•      â”‚
â”‚  - ARO è§’è‰²     â”‚   â”‚    è‡ªå·±çš„æ•¸æ“š     â”‚
â”‚  - DRO è§’è‰²     â”‚   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•¸æ“šåº«è¨­è¨ˆ

### æ ¸å¿ƒæ•¸æ“šè¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  students   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚  guardians   â”‚
â”‚  (å­¸ç”Ÿè¡¨)    â”‚         â”‚  (å®¶é•·è¡¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1:N
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                  â”‚                  â”‚
       â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   grades    â”‚   â”‚ disciplinary â”‚   â”‚   courses    â”‚
â”‚  (æˆç¸¾è¡¨)    â”‚   â”‚  (ç´€å¾‹è¡¨)     â”‚   â”‚  (èª²ç¨‹è¡¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ N:1
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚  staffs  â”‚
                    â”‚ (å“¡å·¥è¡¨)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ æŠ€è¡“æ£§

### å¾Œç«¯æ¡†æ¶
- **Express.js**: Web æ¡†æ¶
- **Knex.js**: SQL æŸ¥è©¢æ§‹å»ºå™¨
- **mysql2**: MySQL é©…å‹•

### ä¸­é–“ä»¶
- **cookie-parser**: Cookie è§£æ
- **express.json()**: JSON è«‹æ±‚é«”è§£æ

### é–‹ç™¼å·¥å…·
- **Node.js**: é‹è¡Œç’°å¢ƒ
- **Yarn**: åŒ…ç®¡ç†å™¨
- **ESM**: ES6 æ¨¡å¡Šç³»çµ±

---

## ğŸ“¦ ä¾è³´èªªæ˜

```json
{
  "dependencies": {
    "express": "^4.18.2",          // Web æ¡†æ¶
    "knex": "^2.4.2",              // SQL æŸ¥è©¢æ§‹å»ºå™¨
    "mysql2": "^3.2.0",            // MySQL é©…å‹•
    "cookie-parser": "^1.4.6"      // Cookie è§£æ
  },
  "devDependencies": {
    "node-fetch": "^3.3.0"         // HTTP å®¢æˆ¶ç«¯ï¼ˆæ¸¬è©¦ç”¨ï¼‰
  }
}
```

---

## ğŸ”„ æ•¸æ“šæµå‘

### è«‹æ±‚è™•ç†æµç¨‹

```
1. å®¢æˆ¶ç«¯ç™¼é€è«‹æ±‚
   â†“
2. Express æ¥æ”¶è«‹æ±‚
   â†“
3. è·¯ç”±åŒ¹é… (routes/)
   â†“
4. ä¸­é–“ä»¶è™•ç† (middleware/)
   - authenticate: é©—è­‰èº«ä»½
   - requireStaff: æª¢æŸ¥å“¡å·¥æ¬Šé™
   - requireRole: æª¢æŸ¥è§’è‰²æ¬Šé™
   â†“
5. æ§åˆ¶å™¨è™•ç† (controllers/)
   - è§£æè«‹æ±‚åƒæ•¸
   - åŸ·è¡Œæ¥­å‹™é‚è¼¯
   - æ•¸æ“šåº«æ“ä½œï¼ˆåŠ å¯†/è§£å¯†ï¼‰
   â†“
6. è¿”å› JSON éŸ¿æ‡‰
   â†“
7. å®¢æˆ¶ç«¯æ¥æ”¶éŸ¿æ‡‰
```

---

## ğŸ“ å‘½åè¦ç¯„

### æ–‡ä»¶å‘½å
- æ§åˆ¶å™¨: `xxxController.js`
- è·¯ç”±: ç°¡çŸ­åç¨±ï¼ˆ`auth.js`, `student.js`ï¼‰
- ä¸­é–“ä»¶: åŠŸèƒ½åç¨±ï¼ˆ`auth.js`ï¼‰

### å‡½æ•¸å‘½å
- ç²å–æ‰€æœ‰: `getAll` / `getAllXxx`
- ç²å–å–®å€‹: `getById` / `getXxxById`
- æ·»åŠ : `add` / `addXxx`
- ç·¨è¼¯: `edit` / `editXxx`
- åˆªé™¤: `delete` / `deleteXxx`

### è·¯ç”±å‘½å
- RESTful é¢¨æ ¼
- ä½¿ç”¨è¤‡æ•¸å½¢å¼ï¼ˆ`/students`, `/grades`ï¼‰
- åƒæ•¸ä½¿ç”¨ `:id`

---

## ğŸš€ æ“´å±•æŒ‡å—

### æ·»åŠ æ–°æ¨¡å¡Š

1. **å‰µå»ºæ§åˆ¶å™¨** (`src/controllers/newController.js`)
2. **å‰µå»ºè·¯ç”±** (`src/routes/new.js`)
3. **è¨»å†Šè·¯ç”±** (åœ¨ `src/index.js` ä¸­)
4. **æ·»åŠ æ¬Šé™** (åœ¨ `src/middleware/auth.js` ä¸­)
5. **æ›´æ–°æ–‡æª”** (API.md)

### æ·»åŠ æ–°æ¬Šé™

1. åœ¨ `src/middleware/auth.js` æ·»åŠ æ–°çš„ä¸­é–“ä»¶å‡½æ•¸
2. åœ¨è·¯ç”±ä¸­ä½¿ç”¨æ–°çš„ä¸­é–“ä»¶
3. æ›´æ–°æ¬Šé™æ–‡æª”

---

## ğŸ“Œ æ³¨æ„äº‹é …

1. **æ‰€æœ‰æ§åˆ¶å™¨å¿…é ˆè™•ç†ç•°å¸¸** (try-catch)
2. **æ‰€æœ‰éŸ¿æ‡‰ä½¿ç”¨çµ±ä¸€æ ¼å¼** (`{ success, data/message }`)
3. **æ•æ„Ÿæ•¸æ“šå¿…é ˆåŠ å¯†** (AES_ENCRYPT)
4. **æŸ¥è©¢æ™‚å¿…é ˆè§£å¯†** (AES_DECRYPT + CAST)
5. **ä½¿ç”¨ signed cookies** é˜²æ­¢ç¯¡æ”¹
6. **ç”Ÿç”¢ç’°å¢ƒä¿®æ”¹æ‰€æœ‰å¯†é‘°**
